[{"SourceCode":"pragma solidity 0.5.8;\r\n\r\ninterface ERC20 {\r\n    function totalSupply() external view returns (uint);\r\n    function balanceOf(address who) external view returns (uint);\r\n    function transfer(address to, uint value) external returns (bool);\r\n    function allowance(address owner, address spender) external view returns (uint);\r\n    function transferFrom(address from, address to, uint value) external returns (bool);\r\n    function approve(address spender, uint value) external returns (bool);\r\n}\r\n\r\ncontract ERC20AtomicSwapper {\r\n\r\n    struct Swap {\r\n        uint256 outAmount;\r\n        uint256 expireHeight;\r\n        bytes32 randomNumberHash;\r\n        uint64  timestamp;\r\n        address sender;\r\n        address recipientAddr;\r\n    }\r\n\r\n    enum States {\r\n        INVALID,\r\n        OPEN,\r\n        COMPLETED,\r\n        EXPIRED\r\n    }\r\n\r\n    // Events\r\n    event HTLT(address indexed _msgSender, address indexed _recipientAddr, bytes32 indexed _swapID, bytes32 _randomNumberHash, uint64 _timestamp, bytes20 _bep2Addr, uint256 _expireHeight, uint256 _outAmount, uint256 _bep2Amount);\r\n    event Refunded(address indexed _msgSender, address indexed _recipientAddr, bytes32 indexed _swapID, bytes32 _randomNumberHash);\r\n    event Claimed(address indexed _msgSender, address indexed _recipientAddr, bytes32 indexed _swapID, bytes32 _randomNumberHash, bytes32 _randomNumber);\r\n\r\n    // Storage\r\n    mapping (bytes32 =\u003E Swap) private swaps;\r\n    mapping (bytes32 =\u003E States) private swapStates;\r\n\r\n    address public ERC20ContractAddr;\r\n\r\n    /// @notice Throws if the swap is not open.\r\n    modifier onlyOpenSwaps(bytes32 _swapID) {\r\n        require(swapStates[_swapID] == States.OPEN, \u0022swap is not opened\u0022);\r\n        _;\r\n    }\r\n\r\n    /// @notice Throws if the swap is already expired.\r\n    modifier onlyAfterExpireHeight(bytes32 _swapID) {\r\n        require(block.number \u003E= swaps[_swapID].expireHeight, \u0022swap is not expired\u0022);\r\n        _;\r\n    }\r\n\r\n    /// @notice Throws if the expireHeight is reached\r\n    modifier onlyBeforeExpireHeight(bytes32 _swapID) {\r\n        require(block.number \u003C swaps[_swapID].expireHeight, \u0022swap is already expired\u0022);\r\n        _;\r\n    }\r\n\r\n    /// @notice Throws if the random number is not valid.\r\n    modifier onlyWithRandomNumber(bytes32 _swapID, bytes32 _randomNumber) {\r\n        require(swaps[_swapID].randomNumberHash == sha256(abi.encodePacked(_randomNumber, swaps[_swapID].timestamp)), \u0022invalid randomNumber\u0022);\r\n        _;\r\n    }\r\n\r\n    constructor() public {\r\n        ERC20ContractAddr = address(0x1b22C32cD936cB97C28C5690a0695a82Abf688e6);\r\n    }\r\n\r\n    /// @notice htlt locks asset to contract address and create an atomic swap.\r\n    ///\r\n    /// @param _randomNumberHash The hash of the random number and timestamp\r\n    /// @param _timestamp Counted by second\r\n    /// @param _heightSpan The number of blocks to wait before the asset can be returned to sender\r\n    /// @param _recipientAddr The ethereum address of the swap counterpart.\r\n    /// @param _bep2SenderAddr the swap sender address on Binance Chain\r\n    /// @param _bep2RecipientAddr The recipient address on Binance Chain\r\n    /// @param _outAmount ERC20 asset to swap out.\r\n    /// @param _bep2Amount BEP2 asset to swap in.\r\n    function htlt(\r\n        bytes32 _randomNumberHash,\r\n        uint64  _timestamp,\r\n        uint256 _heightSpan,\r\n        address _recipientAddr,\r\n        bytes20 _bep2SenderAddr,\r\n        bytes20 _bep2RecipientAddr,\r\n        uint256 _outAmount,\r\n        uint256 _bep2Amount\r\n    ) external returns (bool) {\r\n        bytes32 swapID = calSwapID(_randomNumberHash, msg.sender, _bep2SenderAddr);\r\n        require(swapStates[swapID] == States.INVALID, \u0022swap is opened previously\u0022);\r\n        // Assume average block time interval is 10 second\r\n        // The heightSpan period should be more than 10 minutes and less than one week\r\n        require(_heightSpan \u003E= 60 \u0026\u0026 _heightSpan \u003C= 60480, \u0022_heightSpan should be in [60, 60480]\u0022);\r\n        require(_recipientAddr != address(0), \u0022_recipientAddr should not be zero\u0022);\r\n        require(_outAmount \u003E 0, \u0022_outAmount must be more than 0\u0022);\r\n        require(_timestamp \u003E now - 1800 \u0026\u0026 _timestamp \u003C now \u002B 900, \u0022Timestamp can neither be 15 minutes ahead of the current time, nor 30 minutes later\u0022);\r\n        // Store the details of the swap.\r\n        Swap memory swap = Swap({\r\n            outAmount: _outAmount,\r\n            expireHeight: _heightSpan \u002B block.number,\r\n            randomNumberHash: _randomNumberHash,\r\n            timestamp: _timestamp,\r\n            sender: msg.sender,\r\n            recipientAddr: _recipientAddr\r\n        });\r\n\r\n        swaps[swapID] = swap;\r\n        swapStates[swapID] = States.OPEN;\r\n\r\n        // Transfer ERC20 token to the swap contract\r\n        require(ERC20(ERC20ContractAddr).transferFrom(msg.sender, address(this), _outAmount), \u0022failed to transfer client asset to swap contract address\u0022);\r\n\r\n        // Emit initialization event\r\n        emit HTLT(\r\n            msg.sender,\r\n            _recipientAddr,\r\n            swapID,\r\n            _randomNumberHash,\r\n            _timestamp,\r\n            _bep2RecipientAddr,\r\n            swap.expireHeight,\r\n            _outAmount,\r\n            _bep2Amount);\r\n        return true;\r\n    }\r\n\r\n    /// @notice claim claims the previously locked asset.\r\n    ///\r\n    /// @param _swapID The hash of randomNumberHash, swap creator and swap recipient\r\n    /// @param _randomNumber The random number\r\n    function claim(bytes32 _swapID, bytes32 _randomNumber) external onlyOpenSwaps(_swapID) onlyBeforeExpireHeight(_swapID) onlyWithRandomNumber(_swapID, _randomNumber) returns (bool) {\r\n        // Complete the swap.\r\n        swapStates[_swapID] = States.COMPLETED;\r\n\r\n        address recipientAddr = swaps[_swapID].recipientAddr;\r\n        uint256 outAmount = swaps[_swapID].outAmount;\r\n        bytes32 randomNumberHash = swaps[_swapID].randomNumberHash;\r\n        // delete closed swap\r\n        delete swaps[_swapID];\r\n\r\n        // Pay erc20 token to recipient\r\n        require(ERC20(ERC20ContractAddr).transfer(recipientAddr, outAmount), \u0022Failed to transfer locked asset to recipient\u0022);\r\n\r\n        // Emit completion event\r\n        emit Claimed(msg.sender, recipientAddr, _swapID, randomNumberHash, _randomNumber);\r\n\r\n        return true;\r\n    }\r\n\r\n    /// @notice refund refunds the previously locked asset.\r\n    ///\r\n    /// @param _swapID The hash of randomNumberHash, swap creator and swap recipient\r\n    function refund(bytes32 _swapID) external onlyOpenSwaps(_swapID) onlyAfterExpireHeight(_swapID) returns (bool) {\r\n        // Expire the swap.\r\n        swapStates[_swapID] = States.EXPIRED;\r\n\r\n        address swapSender = swaps[_swapID].sender;\r\n        uint256 outAmount = swaps[_swapID].outAmount;\r\n        bytes32 randomNumberHash = swaps[_swapID].randomNumberHash;\r\n        // delete closed swap\r\n        delete swaps[_swapID];\r\n\r\n        // refund erc20 token to swap creator\r\n        require(ERC20(ERC20ContractAddr).transfer(swapSender, outAmount), \u0022Failed to transfer locked asset back to swap creator\u0022);\r\n\r\n        // Emit expire event\r\n        emit Refunded(msg.sender, swapSender, _swapID, randomNumberHash);\r\n\r\n        return true;\r\n    }\r\n\r\n    /// @notice query an atomic swap by randomNumberHash\r\n    ///\r\n    /// @param _swapID The hash of randomNumberHash, swap creator and swap recipient\r\n    function queryOpenSwap(bytes32 _swapID) external view returns(bytes32 _randomNumberHash, uint64 _timestamp, uint256 _expireHeight, uint256 _outAmount, address _sender, address _recipient) {\r\n        Swap memory swap = swaps[_swapID];\r\n        return (\r\n            swap.randomNumberHash,\r\n            swap.timestamp,\r\n            swap.expireHeight,\r\n            swap.outAmount,\r\n            swap.sender,\r\n            swap.recipientAddr\r\n        );\r\n    }\r\n\r\n    /// @notice Checks whether a swap with specified swapID exist\r\n    ///\r\n    /// @param _swapID The hash of randomNumberHash, swap creator and swap recipient\r\n    function isSwapExist(bytes32 _swapID) external view returns (bool) {\r\n        return (swapStates[_swapID] != States.INVALID);\r\n    }\r\n\r\n    /// @notice Checks whether a swap is refundable or not.\r\n    ///\r\n    /// @param _swapID The hash of randomNumberHash, swap creator and swap recipient\r\n    function refundable(bytes32 _swapID) external view returns (bool) {\r\n        return (block.number \u003E= swaps[_swapID].expireHeight \u0026\u0026 swapStates[_swapID] == States.OPEN);\r\n    }\r\n\r\n    /// @notice Checks whether a swap is claimable or not.\r\n    ///\r\n    /// @param _swapID The hash of randomNumberHash, swap creator and swap recipient\r\n    function claimable(bytes32 _swapID) external view returns (bool) {\r\n        return (block.number \u003C swaps[_swapID].expireHeight \u0026\u0026 swapStates[_swapID] == States.OPEN);\r\n    }\r\n\r\n    /// @notice Calculate the swapID from randomNumberHash and swapCreator\r\n    ///\r\n    /// @param _randomNumberHash The hash of random number and timestamp.\r\n    /// @param _swapSender The creator of swap.\r\n    /// @param _bep2SenderAddr The sender of swap on Binance Chain.\r\n    function calSwapID(bytes32 _randomNumberHash, address _swapSender, bytes20 _bep2SenderAddr) public pure returns (bytes32) {\r\n        if (_bep2SenderAddr == bytes20(0)) {\r\n            return sha256(abi.encodePacked(_randomNumberHash, _swapSender));\r\n        }\r\n        return sha256(abi.encodePacked(_randomNumberHash, _swapSender, _bep2SenderAddr));\r\n    }\r\n}","ABI":"[{\u0022constant\u0022:true,\u0022inputs\u0022:[],\u0022name\u0022:\u0022ERC20ContractAddr\u0022,\u0022outputs\u0022:[{\u0022name\u0022:\u0022\u0022,\u0022type\u0022:\u0022address\u0022}],\u0022payable\u0022:false,\u0022stateMutability\u0022:\u0022view\u0022,\u0022type\u0022:\u0022function\u0022},{\u0022constant\u0022:true,\u0022inputs\u0022:[{\u0022name\u0022:\u0022_swapID\u0022,\u0022type\u0022:\u0022bytes32\u0022}],\u0022name\u0022:\u0022isSwapExist\u0022,\u0022outputs\u0022:[{\u0022name\u0022:\u0022\u0022,\u0022type\u0022:\u0022bool\u0022}],\u0022payable\u0022:false,\u0022stateMutability\u0022:\u0022view\u0022,\u0022type\u0022:\u0022function\u0022},{\u0022constant\u0022:false,\u0022inputs\u0022:[{\u0022name\u0022:\u0022_swapID\u0022,\u0022type\u0022:\u0022bytes32\u0022}],\u0022name\u0022:\u0022refund\u0022,\u0022outputs\u0022:[{\u0022name\u0022:\u0022\u0022,\u0022type\u0022:\u0022bool\u0022}],\u0022payable\u0022:false,\u0022stateMutability\u0022:\u0022nonpayable\u0022,\u0022type\u0022:\u0022function\u0022},{\u0022constant\u0022:true,\u0022inputs\u0022:[{\u0022name\u0022:\u0022_randomNumberHash\u0022,\u0022type\u0022:\u0022bytes32\u0022},{\u0022name\u0022:\u0022_swapSender\u0022,\u0022type\u0022:\u0022address\u0022},{\u0022name\u0022:\u0022_bep2SenderAddr\u0022,\u0022type\u0022:\u0022bytes20\u0022}],\u0022name\u0022:\u0022calSwapID\u0022,\u0022outputs\u0022:[{\u0022name\u0022:\u0022\u0022,\u0022type\u0022:\u0022bytes32\u0022}],\u0022payable\u0022:false,\u0022stateMutability\u0022:\u0022pure\u0022,\u0022type\u0022:\u0022function\u0022},{\u0022constant\u0022:false,\u0022inputs\u0022:[{\u0022name\u0022:\u0022_swapID\u0022,\u0022type\u0022:\u0022bytes32\u0022},{\u0022name\u0022:\u0022_randomNumber\u0022,\u0022type\u0022:\u0022bytes32\u0022}],\u0022name\u0022:\u0022claim\u0022,\u0022outputs\u0022:[{\u0022name\u0022:\u0022\u0022,\u0022type\u0022:\u0022bool\u0022}],\u0022payable\u0022:false,\u0022stateMutability\u0022:\u0022nonpayable\u0022,\u0022type\u0022:\u0022function\u0022},{\u0022constant\u0022:false,\u0022inputs\u0022:[{\u0022name\u0022:\u0022_randomNumberHash\u0022,\u0022type\u0022:\u0022bytes32\u0022},{\u0022name\u0022:\u0022_timestamp\u0022,\u0022type\u0022:\u0022uint64\u0022},{\u0022name\u0022:\u0022_heightSpan\u0022,\u0022type\u0022:\u0022uint256\u0022},{\u0022name\u0022:\u0022_recipientAddr\u0022,\u0022type\u0022:\u0022address\u0022},{\u0022name\u0022:\u0022_bep2SenderAddr\u0022,\u0022type\u0022:\u0022bytes20\u0022},{\u0022name\u0022:\u0022_bep2RecipientAddr\u0022,\u0022type\u0022:\u0022bytes20\u0022},{\u0022name\u0022:\u0022_outAmount\u0022,\u0022type\u0022:\u0022uint256\u0022},{\u0022name\u0022:\u0022_bep2Amount\u0022,\u0022type\u0022:\u0022uint256\u0022}],\u0022name\u0022:\u0022htlt\u0022,\u0022outputs\u0022:[{\u0022name\u0022:\u0022\u0022,\u0022type\u0022:\u0022bool\u0022}],\u0022payable\u0022:false,\u0022stateMutability\u0022:\u0022nonpayable\u0022,\u0022type\u0022:\u0022function\u0022},{\u0022constant\u0022:true,\u0022inputs\u0022:[{\u0022name\u0022:\u0022_swapID\u0022,\u0022type\u0022:\u0022bytes32\u0022}],\u0022name\u0022:\u0022claimable\u0022,\u0022outputs\u0022:[{\u0022name\u0022:\u0022\u0022,\u0022type\u0022:\u0022bool\u0022}],\u0022payable\u0022:false,\u0022stateMutability\u0022:\u0022view\u0022,\u0022type\u0022:\u0022function\u0022},{\u0022constant\u0022:true,\u0022inputs\u0022:[{\u0022name\u0022:\u0022_swapID\u0022,\u0022type\u0022:\u0022bytes32\u0022}],\u0022name\u0022:\u0022refundable\u0022,\u0022outputs\u0022:[{\u0022name\u0022:\u0022\u0022,\u0022type\u0022:\u0022bool\u0022}],\u0022payable\u0022:false,\u0022stateMutability\u0022:\u0022view\u0022,\u0022type\u0022:\u0022function\u0022},{\u0022constant\u0022:true,\u0022inputs\u0022:[{\u0022name\u0022:\u0022_swapID\u0022,\u0022type\u0022:\u0022bytes32\u0022}],\u0022name\u0022:\u0022queryOpenSwap\u0022,\u0022outputs\u0022:[{\u0022name\u0022:\u0022_randomNumberHash\u0022,\u0022type\u0022:\u0022bytes32\u0022},{\u0022name\u0022:\u0022_timestamp\u0022,\u0022type\u0022:\u0022uint64\u0022},{\u0022name\u0022:\u0022_expireHeight\u0022,\u0022type\u0022:\u0022uint256\u0022},{\u0022name\u0022:\u0022_outAmount\u0022,\u0022type\u0022:\u0022uint256\u0022},{\u0022name\u0022:\u0022_sender\u0022,\u0022type\u0022:\u0022address\u0022},{\u0022name\u0022:\u0022_recipient\u0022,\u0022type\u0022:\u0022address\u0022}],\u0022payable\u0022:false,\u0022stateMutability\u0022:\u0022view\u0022,\u0022type\u0022:\u0022function\u0022},{\u0022inputs\u0022:[],\u0022payable\u0022:false,\u0022stateMutability\u0022:\u0022nonpayable\u0022,\u0022type\u0022:\u0022constructor\u0022},{\u0022anonymous\u0022:false,\u0022inputs\u0022:[{\u0022indexed\u0022:true,\u0022name\u0022:\u0022_msgSender\u0022,\u0022type\u0022:\u0022address\u0022},{\u0022indexed\u0022:true,\u0022name\u0022:\u0022_recipientAddr\u0022,\u0022type\u0022:\u0022address\u0022},{\u0022indexed\u0022:true,\u0022name\u0022:\u0022_swapID\u0022,\u0022type\u0022:\u0022bytes32\u0022},{\u0022indexed\u0022:false,\u0022name\u0022:\u0022_randomNumberHash\u0022,\u0022type\u0022:\u0022bytes32\u0022},{\u0022indexed\u0022:false,\u0022name\u0022:\u0022_timestamp\u0022,\u0022type\u0022:\u0022uint64\u0022},{\u0022indexed\u0022:false,\u0022name\u0022:\u0022_bep2Addr\u0022,\u0022type\u0022:\u0022bytes20\u0022},{\u0022indexed\u0022:false,\u0022name\u0022:\u0022_expireHeight\u0022,\u0022type\u0022:\u0022uint256\u0022},{\u0022indexed\u0022:false,\u0022name\u0022:\u0022_outAmount\u0022,\u0022type\u0022:\u0022uint256\u0022},{\u0022indexed\u0022:false,\u0022name\u0022:\u0022_bep2Amount\u0022,\u0022type\u0022:\u0022uint256\u0022}],\u0022name\u0022:\u0022HTLT\u0022,\u0022type\u0022:\u0022event\u0022},{\u0022anonymous\u0022:false,\u0022inputs\u0022:[{\u0022indexed\u0022:true,\u0022name\u0022:\u0022_msgSender\u0022,\u0022type\u0022:\u0022address\u0022},{\u0022indexed\u0022:true,\u0022name\u0022:\u0022_recipientAddr\u0022,\u0022type\u0022:\u0022address\u0022},{\u0022indexed\u0022:true,\u0022name\u0022:\u0022_swapID\u0022,\u0022type\u0022:\u0022bytes32\u0022},{\u0022indexed\u0022:false,\u0022name\u0022:\u0022_randomNumberHash\u0022,\u0022type\u0022:\u0022bytes32\u0022}],\u0022name\u0022:\u0022Refunded\u0022,\u0022type\u0022:\u0022event\u0022},{\u0022anonymous\u0022:false,\u0022inputs\u0022:[{\u0022indexed\u0022:true,\u0022name\u0022:\u0022_msgSender\u0022,\u0022type\u0022:\u0022address\u0022},{\u0022indexed\u0022:true,\u0022name\u0022:\u0022_recipientAddr\u0022,\u0022type\u0022:\u0022address\u0022},{\u0022indexed\u0022:true,\u0022name\u0022:\u0022_swapID\u0022,\u0022type\u0022:\u0022bytes32\u0022},{\u0022indexed\u0022:false,\u0022name\u0022:\u0022_randomNumberHash\u0022,\u0022type\u0022:\u0022bytes32\u0022},{\u0022indexed\u0022:false,\u0022name\u0022:\u0022_randomNumber\u0022,\u0022type\u0022:\u0022bytes32\u0022}],\u0022name\u0022:\u0022Claimed\u0022,\u0022type\u0022:\u0022event\u0022}]","ContractName":"ERC20AtomicSwapper","CompilerVersion":"v0.5.8\u002Bcommit.23d335f2","OptimizationUsed":"0","Runs":"200","ConstructorArguments":"","Library":"","SwarmSource":"bzzr://c631c88f5efd5e76a670050b3a705f08e7e9bad4768a2f0ba2c6cbe73045a2fb"}]