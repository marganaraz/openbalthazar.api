[{"SourceCode":"pragma solidity ^0.6.0;\r\npragma experimental ABIEncoderV2;\r\n\r\n/**\r\n * @title InstaIndex\r\n * @dev Main Contract For Smart Account Layer. This is also a factory contract, Which deploys new Smart Accounts.\r\n * Also Registry for Smart Account Layer.\r\n */\r\n\r\ninterface AccountInterface {\r\n    function version() external view returns (uint);\r\n    function enable(address authority) external;\r\n    function cast(address[] calldata _targets, bytes[] calldata _datas, address _origin) external payable returns (bytes32[] memory responses);\r\n}\r\n\r\ninterface ListInterface {\r\n    function init(address _account) external;\r\n}\r\n\r\ncontract AddressIndex {\r\n\r\n    event LogNewMaster(address master);\r\n    event LogNewCheck(uint accountVersion, address check);\r\n    event LogNewAccount(address _newAccount, address _connectors, address _check);\r\n\r\n    // The Master Address.\r\n    address public master;\r\n    // The List Registry Address.\r\n    address public list;\r\n\r\n    // Connectors Modules(Account Module Version =\u003E Connectors Registry Module Address).\r\n    mapping (uint =\u003E address) public connectors;\r\n    // Check Modules(Account Module Version =\u003E Check Module Address).\r\n    mapping (uint =\u003E address) public check;\r\n    // Account Modules(Account Module Version =\u003E Account Module Address).\r\n    mapping (uint =\u003E address) public account;\r\n    // Version Count of Account Modules.\r\n    uint public versionCount;\r\n\r\n    /**\r\n    * @dev Throws if the sender not is Master Address.\r\n    */\r\n    modifier isMaster() {\r\n        require(msg.sender == master, \u0022not-master\u0022);\r\n        _;\r\n    }\r\n\r\n    /**\r\n     * @dev Change the Master Address.\r\n     * @param _newMaster New Master Address.\r\n     */\r\n    function changeMaster(address _newMaster) external isMaster {\r\n        require(_newMaster != master, \u0022already-a-master\u0022);\r\n        require(_newMaster != address(0), \u0022not-valid-address\u0022);\r\n        master = _newMaster;\r\n        emit LogNewMaster(_newMaster);\r\n    }\r\n\r\n    /**\r\n     * @dev Change the Check Address of a specfic Account Module version.\r\n     * @param accountVersion Account Module version.\r\n     * @param _newCheck The New Check Address.\r\n     */\r\n    function changeCheck(uint accountVersion, address _newCheck) external isMaster {\r\n        require(_newCheck != check[accountVersion], \u0022already-a-check\u0022);\r\n        require(_newCheck != address(0), \u0022not-valid-address\u0022);\r\n        check[accountVersion] = _newCheck;\r\n        emit LogNewCheck(accountVersion, _newCheck);\r\n    }\r\n\r\n    /**\r\n     * @dev Add New Account Module.\r\n     * @param _newAccount The New Account Module Address.\r\n     * @param _connectors Connectors Registry Module Address.\r\n     * @param _check Check Module Address.\r\n     */\r\n    function addNewAccount(address _newAccount, address _connectors, address _check) external isMaster {\r\n        require(_newAccount != address(0), \u0022not-valid-address\u0022);\r\n        versionCount\u002B\u002B;\r\n        require(AccountInterface(_newAccount).version() == versionCount, \u0022not-valid-version\u0022);\r\n        account[versionCount] = _newAccount;\r\n        if (_connectors != address(0)) connectors[versionCount] = _connectors;\r\n        if (_check != address(0)) check[versionCount] = _check;\r\n        emit LogNewAccount(_newAccount, _connectors, _check);\r\n    }\r\n\r\n}\r\n\r\ncontract CloneFactory is AddressIndex {\r\n    /**\r\n     * @dev Clone a new Account Module.\r\n     * @param version Account Module version to clone.\r\n     */\r\n    function createClone(uint version) internal returns (address result) {\r\n        bytes20 targetBytes = bytes20(account[version]);\r\n        // solium-disable-next-line security/no-inline-assembly\r\n        assembly {\r\n            let clone := mload(0x40)\r\n            mstore(clone, 0x3d602d80600a3d3981f3363d3d373d3d3d363d73000000000000000000000000)\r\n            mstore(add(clone, 0x14), targetBytes)\r\n            mstore(add(clone, 0x28), 0x5af43d82803e903d91602b57fd5bf30000000000000000000000000000000000)\r\n            result := create(0, clone, 0x37)\r\n        }\r\n    }\r\n\r\n    /**\r\n     * @dev Check if Account Module is a clone.\r\n     * @param version Account Module version.\r\n     * @param query Account Module Address.\r\n     */\r\n    function isClone(uint version, address query) external view returns (bool result) {\r\n        bytes20 targetBytes = bytes20(account[version]);\r\n        // solium-disable-next-line security/no-inline-assembly\r\n        assembly {\r\n            let clone := mload(0x40)\r\n            mstore(clone, 0x363d3d373d3d3d363d7300000000000000000000000000000000000000000000)\r\n            mstore(add(clone, 0xa), targetBytes)\r\n            mstore(add(clone, 0x1e), 0x5af43d82803e903d91602b57fd5bf30000000000000000000000000000000000)\r\n\r\n            let other := add(clone, 0x40)\r\n            extcodecopy(query, other, 0, 0x2d)\r\n            result := and(\r\n                eq(mload(clone), mload(other)),\r\n                eq(mload(add(clone, 0xd)), mload(add(other, 0xd)))\r\n            )\r\n        }\r\n    }\r\n}\r\n\r\ncontract InstaIndex is CloneFactory {\r\n\r\n    event AccountCreated(address sender, address indexed owner, address account, address indexed origin);\r\n\r\n    /**\r\n     * @dev Create a new Smart Account for a user and run cast function in the new Smart Account.\r\n     * @param _owner Owner of the Smart Account.\r\n     * @param accountVersion Account Module version.\r\n     * @param _targets Array of Target to run cast function.\r\n     * @param _datas Array of Data(callData) to run cast function.\r\n     * @param _origin Where Smart Account is created.\r\n     */\r\n    function buildWithCast(\r\n        address _owner,\r\n        uint accountVersion,\r\n        address[] calldata _targets,\r\n        bytes[] calldata _datas,\r\n        address _origin\r\n    ) external payable returns (address _account) {\r\n        _account = build(_owner, accountVersion, _origin);\r\n        if (_targets.length \u003E 0) AccountInterface(_account).cast.value(msg.value)(_targets, _datas, _origin);\r\n    }\r\n\r\n    /**\r\n     * @dev Create a new Smart Account for a user.\r\n     * @param _owner Owner of the Smart Account.\r\n     * @param accountVersion Account Module version.\r\n     * @param _origin Where Smart Account is created.\r\n     */\r\n    function build(\r\n        address _owner,\r\n        uint accountVersion,\r\n        address _origin\r\n    ) public returns (address _account) {\r\n        require(accountVersion != 0 \u0026\u0026 accountVersion \u003C= versionCount, \u0022not-valid-account\u0022);\r\n        _account = createClone(accountVersion);\r\n        ListInterface(list).init(_account);\r\n        AccountInterface(_account).enable(_owner);\r\n        emit AccountCreated(msg.sender, _owner, _account, _origin);\r\n    }\r\n\r\n    /**\r\n     * @dev Setup Initial things for InstaIndex, after its been deployed and can be only run once.\r\n     * @param _master The Master Address.\r\n     * @param _list The List Address.\r\n     * @param _account The Account Module Address.\r\n     * @param _connectors The Connectors Registry Module Address.\r\n     */\r\n    function setBasics(\r\n        address _master,\r\n        address _list,\r\n        address _account,\r\n        address _connectors\r\n    ) external {\r\n        require(\r\n            master == address(0) \u0026\u0026\r\n            list == address(0) \u0026\u0026\r\n            account[1] == address(0) \u0026\u0026\r\n            connectors[1] == address(0) \u0026\u0026\r\n            versionCount == 0,\r\n            \u0022already-defined\u0022\r\n        );\r\n        master = _master;\r\n        list = _list;\r\n        versionCount\u002B\u002B;\r\n        account[versionCount] = _account;\r\n        connectors[versionCount] = _connectors;\r\n    }\r\n\r\n}","ABI":"[{\u0022anonymous\u0022:false,\u0022inputs\u0022:[{\u0022indexed\u0022:false,\u0022internalType\u0022:\u0022address\u0022,\u0022name\u0022:\u0022sender\u0022,\u0022type\u0022:\u0022address\u0022},{\u0022indexed\u0022:true,\u0022internalType\u0022:\u0022address\u0022,\u0022name\u0022:\u0022owner\u0022,\u0022type\u0022:\u0022address\u0022},{\u0022indexed\u0022:false,\u0022internalType\u0022:\u0022address\u0022,\u0022name\u0022:\u0022account\u0022,\u0022type\u0022:\u0022address\u0022},{\u0022indexed\u0022:true,\u0022internalType\u0022:\u0022address\u0022,\u0022name\u0022:\u0022origin\u0022,\u0022type\u0022:\u0022address\u0022}],\u0022name\u0022:\u0022AccountCreated\u0022,\u0022type\u0022:\u0022event\u0022},{\u0022anonymous\u0022:false,\u0022inputs\u0022:[{\u0022indexed\u0022:false,\u0022internalType\u0022:\u0022address\u0022,\u0022name\u0022:\u0022_newAccount\u0022,\u0022type\u0022:\u0022address\u0022},{\u0022indexed\u0022:false,\u0022internalType\u0022:\u0022address\u0022,\u0022name\u0022:\u0022_connectors\u0022,\u0022type\u0022:\u0022address\u0022},{\u0022indexed\u0022:false,\u0022internalType\u0022:\u0022address\u0022,\u0022name\u0022:\u0022_check\u0022,\u0022type\u0022:\u0022address\u0022}],\u0022name\u0022:\u0022LogNewAccount\u0022,\u0022type\u0022:\u0022event\u0022},{\u0022anonymous\u0022:false,\u0022inputs\u0022:[{\u0022indexed\u0022:false,\u0022internalType\u0022:\u0022uint256\u0022,\u0022name\u0022:\u0022accountVersion\u0022,\u0022type\u0022:\u0022uint256\u0022},{\u0022indexed\u0022:false,\u0022internalType\u0022:\u0022address\u0022,\u0022name\u0022:\u0022check\u0022,\u0022type\u0022:\u0022address\u0022}],\u0022name\u0022:\u0022LogNewCheck\u0022,\u0022type\u0022:\u0022event\u0022},{\u0022anonymous\u0022:false,\u0022inputs\u0022:[{\u0022indexed\u0022:false,\u0022internalType\u0022:\u0022address\u0022,\u0022name\u0022:\u0022master\u0022,\u0022type\u0022:\u0022address\u0022}],\u0022name\u0022:\u0022LogNewMaster\u0022,\u0022type\u0022:\u0022event\u0022},{\u0022inputs\u0022:[{\u0022internalType\u0022:\u0022uint256\u0022,\u0022name\u0022:\u0022\u0022,\u0022type\u0022:\u0022uint256\u0022}],\u0022name\u0022:\u0022account\u0022,\u0022outputs\u0022:[{\u0022internalType\u0022:\u0022address\u0022,\u0022name\u0022:\u0022\u0022,\u0022type\u0022:\u0022address\u0022}],\u0022stateMutability\u0022:\u0022view\u0022,\u0022type\u0022:\u0022function\u0022},{\u0022inputs\u0022:[{\u0022internalType\u0022:\u0022address\u0022,\u0022name\u0022:\u0022_newAccount\u0022,\u0022type\u0022:\u0022address\u0022},{\u0022internalType\u0022:\u0022address\u0022,\u0022name\u0022:\u0022_connectors\u0022,\u0022type\u0022:\u0022address\u0022},{\u0022internalType\u0022:\u0022address\u0022,\u0022name\u0022:\u0022_check\u0022,\u0022type\u0022:\u0022address\u0022}],\u0022name\u0022:\u0022addNewAccount\u0022,\u0022outputs\u0022:[],\u0022stateMutability\u0022:\u0022nonpayable\u0022,\u0022type\u0022:\u0022function\u0022},{\u0022inputs\u0022:[{\u0022internalType\u0022:\u0022address\u0022,\u0022name\u0022:\u0022_owner\u0022,\u0022type\u0022:\u0022address\u0022},{\u0022internalType\u0022:\u0022uint256\u0022,\u0022name\u0022:\u0022accountVersion\u0022,\u0022type\u0022:\u0022uint256\u0022},{\u0022internalType\u0022:\u0022address\u0022,\u0022name\u0022:\u0022_origin\u0022,\u0022type\u0022:\u0022address\u0022}],\u0022name\u0022:\u0022build\u0022,\u0022outputs\u0022:[{\u0022internalType\u0022:\u0022address\u0022,\u0022name\u0022:\u0022_account\u0022,\u0022type\u0022:\u0022address\u0022}],\u0022stateMutability\u0022:\u0022nonpayable\u0022,\u0022type\u0022:\u0022function\u0022},{\u0022inputs\u0022:[{\u0022internalType\u0022:\u0022address\u0022,\u0022name\u0022:\u0022_owner\u0022,\u0022type\u0022:\u0022address\u0022},{\u0022internalType\u0022:\u0022uint256\u0022,\u0022name\u0022:\u0022accountVersion\u0022,\u0022type\u0022:\u0022uint256\u0022},{\u0022internalType\u0022:\u0022address[]\u0022,\u0022name\u0022:\u0022_targets\u0022,\u0022type\u0022:\u0022address[]\u0022},{\u0022internalType\u0022:\u0022bytes[]\u0022,\u0022name\u0022:\u0022_datas\u0022,\u0022type\u0022:\u0022bytes[]\u0022},{\u0022internalType\u0022:\u0022address\u0022,\u0022name\u0022:\u0022_origin\u0022,\u0022type\u0022:\u0022address\u0022}],\u0022name\u0022:\u0022buildWithCast\u0022,\u0022outputs\u0022:[{\u0022internalType\u0022:\u0022address\u0022,\u0022name\u0022:\u0022_account\u0022,\u0022type\u0022:\u0022address\u0022}],\u0022stateMutability\u0022:\u0022payable\u0022,\u0022type\u0022:\u0022function\u0022},{\u0022inputs\u0022:[{\u0022internalType\u0022:\u0022uint256\u0022,\u0022name\u0022:\u0022accountVersion\u0022,\u0022type\u0022:\u0022uint256\u0022},{\u0022internalType\u0022:\u0022address\u0022,\u0022name\u0022:\u0022_newCheck\u0022,\u0022type\u0022:\u0022address\u0022}],\u0022name\u0022:\u0022changeCheck\u0022,\u0022outputs\u0022:[],\u0022stateMutability\u0022:\u0022nonpayable\u0022,\u0022type\u0022:\u0022function\u0022},{\u0022inputs\u0022:[{\u0022internalType\u0022:\u0022address\u0022,\u0022name\u0022:\u0022_newMaster\u0022,\u0022type\u0022:\u0022address\u0022}],\u0022name\u0022:\u0022changeMaster\u0022,\u0022outputs\u0022:[],\u0022stateMutability\u0022:\u0022nonpayable\u0022,\u0022type\u0022:\u0022function\u0022},{\u0022inputs\u0022:[{\u0022internalType\u0022:\u0022uint256\u0022,\u0022name\u0022:\u0022\u0022,\u0022type\u0022:\u0022uint256\u0022}],\u0022name\u0022:\u0022check\u0022,\u0022outputs\u0022:[{\u0022internalType\u0022:\u0022address\u0022,\u0022name\u0022:\u0022\u0022,\u0022type\u0022:\u0022address\u0022}],\u0022stateMutability\u0022:\u0022view\u0022,\u0022type\u0022:\u0022function\u0022},{\u0022inputs\u0022:[{\u0022internalType\u0022:\u0022uint256\u0022,\u0022name\u0022:\u0022\u0022,\u0022type\u0022:\u0022uint256\u0022}],\u0022name\u0022:\u0022connectors\u0022,\u0022outputs\u0022:[{\u0022internalType\u0022:\u0022address\u0022,\u0022name\u0022:\u0022\u0022,\u0022type\u0022:\u0022address\u0022}],\u0022stateMutability\u0022:\u0022view\u0022,\u0022type\u0022:\u0022function\u0022},{\u0022inputs\u0022:[{\u0022internalType\u0022:\u0022uint256\u0022,\u0022name\u0022:\u0022version\u0022,\u0022type\u0022:\u0022uint256\u0022},{\u0022internalType\u0022:\u0022address\u0022,\u0022name\u0022:\u0022query\u0022,\u0022type\u0022:\u0022address\u0022}],\u0022name\u0022:\u0022isClone\u0022,\u0022outputs\u0022:[{\u0022internalType\u0022:\u0022bool\u0022,\u0022name\u0022:\u0022result\u0022,\u0022type\u0022:\u0022bool\u0022}],\u0022stateMutability\u0022:\u0022view\u0022,\u0022type\u0022:\u0022function\u0022},{\u0022inputs\u0022:[],\u0022name\u0022:\u0022list\u0022,\u0022outputs\u0022:[{\u0022internalType\u0022:\u0022address\u0022,\u0022name\u0022:\u0022\u0022,\u0022type\u0022:\u0022address\u0022}],\u0022stateMutability\u0022:\u0022view\u0022,\u0022type\u0022:\u0022function\u0022},{\u0022inputs\u0022:[],\u0022name\u0022:\u0022master\u0022,\u0022outputs\u0022:[{\u0022internalType\u0022:\u0022address\u0022,\u0022name\u0022:\u0022\u0022,\u0022type\u0022:\u0022address\u0022}],\u0022stateMutability\u0022:\u0022view\u0022,\u0022type\u0022:\u0022function\u0022},{\u0022inputs\u0022:[{\u0022internalType\u0022:\u0022address\u0022,\u0022name\u0022:\u0022_master\u0022,\u0022type\u0022:\u0022address\u0022},{\u0022internalType\u0022:\u0022address\u0022,\u0022name\u0022:\u0022_list\u0022,\u0022type\u0022:\u0022address\u0022},{\u0022internalType\u0022:\u0022address\u0022,\u0022name\u0022:\u0022_account\u0022,\u0022type\u0022:\u0022address\u0022},{\u0022internalType\u0022:\u0022address\u0022,\u0022name\u0022:\u0022_connectors\u0022,\u0022type\u0022:\u0022address\u0022}],\u0022name\u0022:\u0022setBasics\u0022,\u0022outputs\u0022:[],\u0022stateMutability\u0022:\u0022nonpayable\u0022,\u0022type\u0022:\u0022function\u0022},{\u0022inputs\u0022:[],\u0022name\u0022:\u0022versionCount\u0022,\u0022outputs\u0022:[{\u0022internalType\u0022:\u0022uint256\u0022,\u0022name\u0022:\u0022\u0022,\u0022type\u0022:\u0022uint256\u0022}],\u0022stateMutability\u0022:\u0022view\u0022,\u0022type\u0022:\u0022function\u0022}]","ContractName":"InstaIndex","CompilerVersion":"v0.6.1\u002Bcommit.e6f7d5a4","OptimizationUsed":"0","Runs":"200","ConstructorArguments":"","Library":"","SwarmSource":"ipfs://1e75f3014e573f8d6bfa1253ea1ac9626ade60acd43b432a387b971527d9dd14"}]